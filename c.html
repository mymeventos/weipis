<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte General de Gastos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            color: #007bff;
            margin-bottom: 40px;
        }
        h2 {
            color: #333;
            margin-top: 0;
        }
        .section {
            border-bottom: 2px solid #ddd;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }
        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            white-space: nowrap;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        td.pagado {
            background-color: #d4edda;
        }
        td.adeudado {
            background-color: #f8d7da;
        }
        .saldo-total {
            text-align: right;
            font-size: 1.2em;
            margin-top: 10px;
            font-weight: bold;
        }
        .form-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .form-section input, .form-section select {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .form-section button {
            padding: 8px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .inflacion-input {
            width: 80px;
        }
        .delete-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            color: #dc3545;
            padding: 0;
            margin: 0 auto;
            display: block;
        }
        .pasteleria-cell {
            text-align: center;
        }
        .pasteleria-table-container {
            display: none;
            margin-bottom: 20px;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        .pasteleria-nav {
            text-align: center;
            margin-bottom: 20px;
        }
        .pasteleria-nav button {
            padding: 8px 15px;
            margin: 0 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .pasteleria-nav button.active {
            background-color: #0056b3;
        }
        .summary-table input[type="number"] {
            width: 90%;
            border: none;
            background-color: transparent;
            padding: 0;
            font-size: inherit;
        }
        .summary-table td {
            text-align: right;
        }
        .summary-table td:first-child {
            text-align: left;
        }
        .currency-input-container, .interes-input-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 5px;
            box-sizing: border-box;
            width: 100%;
        }
        .currency-input-container::before {
            content: '$';
            padding-right: 5px;
            color: #333;
        }
        .currency-input-container input {
            text-align: right;
            padding: 0;
        }
        .interes-input-container {
            justify-content: center;
            width: auto;
        }
        .interes-input-container input {
            width: 50px;
            text-align: right;
        }
        .interes-input-container::after {
            content: '%';
            padding-left: 5px;
            color: #333;
        }
        .editable {
            cursor: pointer;
        }
        .editable:hover {
            background-color: #e9ecef;
        }
        .edit-input {
            width: 100%;
            border: none;
            box-sizing: border-box;
            padding: 0;
            margin: 0;
            background-color: transparent;
            font-size: inherit;
            font-family: inherit;
            text-align: inherit;
        }
        .save-btn-month {
            margin-top: 20px;
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
        }
        .save-btn-month:hover {
            background-color: #0056b3;
        }
        .price-input {
            width: 90%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            box-sizing: border-box;
        }
        .pasteleria-table-container .tfoot-price-cell {
            padding: 5px;
            vertical-align: middle;
            text-align: center;
        }
        /* selector a√±o */
        .year-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .year-selector select {
            width: 120px;
            padding: 6px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Reporte General de Gastos y Sueldos</h1>
    
    <div class="section">
        <h2>Pr√©stamo</h2>
        <div id="prestamo-content">
            <p>Monto Inicial: $6.000.000,00</p>
            <p>Inter√©s Semanal: 1.5%</p>
            <p>Fecha de Inicio: 7/01/2025</p>
            <div class="saldo-total">Monto Adeudado a la fecha: <span id="montoFinalPrestamo"></span></div>
        </div>
    </div>
    
    <div class="section">
        <h2>Caja Chica</h2>
        <div class="form-section">
            <input type="date" id="gasto-fecha" placeholder="Fecha">
            <input type="text" id="gasto-descripcion" placeholder="Descripci√≥n">
            <input type="number" id="gasto-monto" step="0.01" placeholder="Monto">
            <button id="btn-agregar-gasto">Agregar Gasto</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Descripci√≥n</th>
                    <th>Monto</th>
                    <th style="width: 40px;"></th>
                </tr>
            </thead>
            <tbody id="caja-chica-list"></tbody>
        </table>
        <div class="saldo-total">Saldo Disponible: <span id="saldo-disponible"></span></div>
    </div>

    <div class="section">
        <h2>Sueldos</h2>
        <div class="form-section">
            <select id="sueldo-mes">
                <option value="Enero">Enero</option>
                <option value="Febrero">Febrero</option>
                <option value="Marzo">Marzo</option>
                <option value="Abril">Abril</option>
                <option value="Mayo">Mayo</option>
                <option value="Junio">Junio</option>
                <option value="Julio">Julio</option>
                <option value="Agosto">Agosto</option>
                <option value="Septiembre">Septiembre</option>
                <option value="Octubre">Octubre</option>
                <option value="Noviembre">Noviembre</option>
                <option value="Diciembre">Diciembre</option>
            </select>
            <input type="number" id="sueldo-montoK" step="0.01" placeholder="Monto 'K'">
            <input type="number" id="sueldo-montoMilei" step="0.01" placeholder="Monto 'Milei'">
            <input type="text" id="sueldo-descripcion" placeholder="Descripci√≥n extra (opcional)">
            <button id="btn-agregar-sueldo">Agregar Sueldo</button>
        </div>
        <table id="sueldos-table">
            <thead>
                <tr>
                    <th>Mes</th>
                    <th>Descripci√≥n</th>
                    <th>Monto 'K'</th>
                    <th>Monto 'Milei'</th>
                    <th>Inflaci√≥n (%)</th>
                    <th style="width: 40px;"></th>
                </tr>
            </thead>
            <tbody id="sueldos-list"></tbody>
            <tfoot>
                <tr id="sueldos-total-row">
                    <td colspan="4" class="saldo-total">Total Adeudado General</td>
                    <td colspan="2" id="sueldos-total" class="saldo-total"></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="section">
        <h2>Pasteler√≠a</h2>
        <div class="pasteleria-nav" id="pasteleria-nav"></div>
        <div id="pasteleria-meses-container"></div>
    </div>

    <div class="section">
        <h2>Resumen Pasteler√≠a</h2>

        <!-- selector de a√±o -->
        <div class="year-selector">
            <label for="selector-ano">üìÖ A√±o:</label>
            <select id="selector-ano">
                <!-- opciones se pueden ajustar -->
                <option value="2025" selected>2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
            </select>
            <div style="margin-left:auto;color:#666;font-size:0.9em;">Los datos de ventas se filtran por el a√±o seleccionado (seg√∫n la fecha)</div>
        </div>

        <table class="summary-table">
            <thead>
                <tr>
                    <th>MES</th>
                    <th>DEUDA DEL MES</th>
                    <th>DEUDA ACUMULADA</th>
                    <th>PAGO</th>
                    <th>% INTER√âS</th>
                    <th>TOTAL</th>
                </tr>
            </thead>
            <tbody id="resumen-pasteleria-body"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBt_R-0uXeZ0-ZbTGX6CbgI6ZWqtov56PA",
      authDomain: "weipis.firebaseapp.com",
      projectId: "weipis",
      storageBucket: "weipis.firebasestorage.app",
      messagingSenderId: "95209854420",
      appId: "1:95209854420:web:c4b5c1636300a04a33f241",
      measurementId: "G-1131L1FKJ4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('es-AR', {
            style: 'currency',
            currency: 'ARS',
            minimumFractionDigits: 2
        }).format(amount);
    };

    const formatDate = (dateString) => {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    };
    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

    // --- L√≥gica de Pr√©stamo ---
    function calcularMontoPrestamo() {
        const montoInicial = 6000000;
        const interesSemanal = 0.015;
        const fechaInicio = new Date('2025-01-07');
        const fechaActual = new Date();
        const unaSemanaEnMs = 1000 * 60 * 60 * 24 * 7;
        const diferenciaMs = fechaActual.getTime() - fechaInicio.getTime();
        const semanasTranscurridas = Math.max(0, Math.floor(diferenciaMs / unaSemanaEnMs));
        
        let montoCalculado = montoInicial;
        for (let i = 0; i < semanasTranscurridas; i++) {
            montoCalculado *= (1 + interesSemanal);
        }
        document.getElementById('montoFinalPrestamo').textContent = formatCurrency(montoCalculado);
    }
    
    // --- L√≥gica de Caja Chica ---
    const saldoInicialCajaChica = 300000;
    const gastosCol = collection(db, 'gastos');
    let gastos = [];
    
    function renderizarCajaChica() {
        const gastosList = document.getElementById('caja-chica-list');
        gastosList.innerHTML = '';
        
        const depositoRow = document.createElement('tr');
        depositoRow.innerHTML = `<td>${formatDate('2025-01-01')}</td><td>DEPOSITO</td><td>${formatCurrency(saldoInicialCajaChica)}</td><td></td>`;
        gastosList.appendChild(depositoRow);

        let totalGastos = 0;
        
        // Ordenar gastos por fecha
        const gastosOrdenados = [...gastos].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

        gastosOrdenados.forEach(gasto => {
            totalGastos += gasto.monto;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(gasto.fecha)}</td>
                <td>${gasto.descripcion}</td>
                <td>- ${formatCurrency(gasto.monto)}</td>
                <td style="text-align: center;"><button class="delete-btn" data-id="${gasto.id}">‚ùå</button></td>
            `;
            gastosList.appendChild(row);
        });

        const saldoFinal = saldoInicialCajaChica - totalGastos;
        document.getElementById('saldo-disponible').textContent = formatCurrency(saldoFinal);
        
        gastosList.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const id = this.dataset.id;
                if (confirm('¬øEst√°s seguro de que deseas eliminar este gasto?')) {
                    const docRef = doc(db, 'gastos', id);
                    await deleteDoc(docRef);
                }
            });
        });
    }
    
    async function agregarGasto() {
        const fecha = document.getElementById('gasto-fecha').value;
        const descripcion = document.getElementById('gasto-descripcion').value;
        const monto = parseFloat(document.getElementById('gasto-monto').value);

        if (fecha && descripcion && !isNaN(monto)) {
            try {
                await addDoc(gastosCol, { fecha, descripcion, monto });
                document.getElementById('gasto-fecha').value = '';
                document.getElementById('gasto-descripcion').value = '';
                document.getElementById('gasto-monto').value = '';
            } catch (e) {
                console.error("Error al agregar documento: ", e);
            }
        } else {
            alert('Por favor, completa todos los campos del gasto.');
        }
    }
    
    onSnapshot(gastosCol, (snapshot) => {
        gastos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderizarCajaChica();
    });
    
    // --- L√≥gica de Sueldos ---
    const sueldosCol = collection(db, 'sueldos');
    const inflacionCol = collection(db, 'inflacion');
    let sueldos = [];
    let inflacionData = {};
    
    function renderizarSueldos() {
        const sueldosList = document.getElementById('sueldos-list');
        sueldosList.innerHTML = '';
        
        let montoAcumuladoConInteres = 0;
        
        const sueldosPorMes = meses.reduce((acc, mes) => {
            acc[mes] = sueldos.filter(s => s.mes === mes);
            return acc;
        }, {});

        meses.forEach((mes) => {
            const pagosDelMes = sueldosPorMes[mes] || [];
            const inflacion = inflacionData[mes] || 0;
            
            montoAcumuladoConInteres *= (1 + inflacion / 100);

            let montoBasePendiente = 0;
            if (pagosDelMes.length > 0) {
                 const totalPagadoK = pagosDelMes.filter(p => p.kPagado).reduce((sum, p) => sum + p.montoK, 0);
                 const totalPagadoMilei = pagosDelMes.filter(p => p.mileiPagado).reduce((sum, p) => sum + p.montoMilei, 0);
                 const totalMontoKMes = pagosDelMes.reduce((sum, p) => sum + p.montoK, 0);
                 const totalMontoMileiMes = pagosDelMes.reduce((sum, p) => sum + p.montoMilei, 0);
                 montoBasePendiente = (totalMontoKMes - totalPagadoK) + (totalMontoMileiMes - totalPagadoMilei);
            }
            montoAcumuladoConInteres += montoBasePendiente;

            if (pagosDelMes.length > 0) {
                pagosDelMes.forEach((pago, index) => {
                    const row = document.createElement('tr');
                    row.dataset.id = pago.id;
                    row.innerHTML = `
                        <td>${index === 0 ? mes : ''}</td>
                        <td class="editable" data-field="descripcion" data-id="${pago.id}">${pago.descripcion}</td>
                        <td class="${pago.kPagado ? 'pagado' : 'adeudado'} editable" data-field="montoK" data-part="k" data-id="${pago.id}">${formatCurrency(pago.montoK)}</td>
                        <td class="${pago.mileiPagado ? 'pagado' : 'adeudado'} editable" data-field="montoMilei" data-part="milei" data-id="${pago.id}">${formatCurrency(pago.montoMilei)}</td>
                        <td>${index === 0 ? `<div class="interes-input-container"><input type="number" class="inflacion-input" value="${inflacion}" step="0.1" data-mes="${mes}"></div>` : ''}</td>
                        <td style="text-align: center;"><button class="delete-btn" data-id="${pago.id}">‚ùå</button></td>
                    `;
                    sueldosList.appendChild(row);
                });
            }
        });
        
        document.getElementById('sueldos-total').textContent = formatCurrency(montoAcumuladoConInteres);
        
        sueldosList.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const id = this.dataset.id;
                if (confirm('¬øEst√°s seguro de que deseas eliminar este registro?')) {
                    const docRef = doc(db, 'sueldos', id);
                    await deleteDoc(docRef);
                }
            });
        });
        
        sueldosList.querySelectorAll('.inflacion-input').forEach(input => {
            input.addEventListener('change', async function() {
                const mes = this.dataset.mes;
                const valor = parseFloat(this.value);
                const docRef = doc(db, 'inflacion', mes);
                await setDoc(docRef, { inflacion: valor }, { merge: true });
            });
        });

        sueldosList.querySelectorAll('td[data-part]').forEach(cell => {
            cell.addEventListener('contextmenu', async function(e) {
                e.preventDefault();
                const id = this.dataset.id;
                const part = this.dataset.part;
                
                const pago = sueldos.find(s => s.id === id);
                if (!pago) return;

                const docRef = doc(db, 'sueldos', id);
                
                if (part === 'k') {
                    await updateDoc(docRef, { kPagado: !pago.kPagado });
                } else if (part === 'milei') {
                    await updateDoc(docRef, { mileiPagado: !pago.mileiPagado });
                }
            });
        });

        sueldosList.querySelectorAll('td.editable').forEach(cell => {
            cell.ondblclick = function() {
                const id = this.dataset.id;
                const field = this.dataset.field;
                const valor = field === 'descripcion' ? this.textContent : parseFloat(this.textContent.replace('$', '').replace(/\./g, '').replace(',', '.')) || 0;
                
                const input = document.createElement('input');
                input.type = field === 'descripcion' ? 'text' : 'number';
                input.className = 'edit-input';
                input.value = field === 'descripcion' ? valor : valor;
                if (field !== 'descripcion') input.step = "0.01";
                
                this.innerHTML = '';
                this.appendChild(input);
                
                input.focus();
                
                input.onblur = async function() {
                    const nuevoValor = field === 'descripcion' ? this.value : parseFloat(this.value) || 0;
                    const docRef = doc(db, 'sueldos', id);
                    await updateDoc(docRef, { [field]: nuevoValor });
                };
            };
        });
    }

    async function agregarSueldo() {
        const mes = document.getElementById('sueldo-mes').value;
        const montoK = parseFloat(document.getElementById('sueldo-montoK').value) || 0;
        const montoMilei = parseFloat(document.getElementById('sueldo-montoMilei').value) || 0;
        const descripcion = document.getElementById('sueldo-descripcion').value || 'Sueldo base';

        if (mes && (!isNaN(montoK) || !isNaN(montoMilei))) {
            try {
                await addDoc(sueldosCol, { mes, descripcion, montoK, montoMilei, kPagado: false, mileiPagado: false });
                document.getElementById('sueldo-montoK').value = '';
                document.getElementById('sueldo-montoMilei').value = '';
                document.getElementById('sueldo-descripcion').value = '';
            } catch (e) {
                console.error("Error al agregar sueldo: ", e);
            }
        } else {
            alert('Por favor, completa los campos de sueldo con valores num√©ricos v√°lidos.');
        }
    }

    onSnapshot(sueldosCol, (snapshot) => {
        sueldos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderizarSueldos();
        attemptActualizarResumen();
    });

    onSnapshot(inflacionCol, (snapshot) => {
        inflacionData = {};
        snapshot.docs.forEach(doc => {
            inflacionData[doc.id] = doc.data().inflacion;
        });
        renderizarSueldos();
        attemptActualizarResumen();
    });

    // --- L√≥gica de Pasteler√≠a ---
    const ventasCol = collection(db, 'ventasPasteleria');
    const preciosCol = collection(db, 'preciosPasteleria');
    const resumenPasteleriaCol = collection(db, 'resumenPasteleria');

    // Estructuras multi-a√±o
    // ventasByYear[year] = { 'Enero': [...], 'Febrero': [...] ... }
    let ventasByYear = {};
    // precios: dos mapas, uno por mes (legacy) y otro por a√±o_mes (nueva)
    let preciosByMonth = {}; // legacy: preciosByMonth['Enero'] = {DIATORTAS:..., MESADULCE:..., CELIACO:...}
    let preciosByYearMonth = {}; // preciosByYearMonth['2025_Enero'] = {...}
    // resumenByYear[year] = { 'Enero': {...}, 'Febrero': {...} }
    let resumenByYear = {};

    let ventasLoaded = false;
    let preciosLoaded = false;
    let resumenLoaded = false;

    let mesActualPasteleria = 'Febrero';

    function crearTablasPasteleria() {
        const nav = document.getElementById('pasteleria-nav');
        nav.innerHTML = '';
        meses.forEach(mes => {
            const button = document.createElement('button');
            button.textContent = mes;
            button.addEventListener('click', () => mostrarTablaPasteleria(mes));
            nav.appendChild(button);
        });
        const container = document.getElementById('pasteleria-meses-container');
        container.innerHTML = '';
        meses.forEach(mes => {
            const tableContainer = document.createElement('div');
            tableContainer.id = `tabla-pasteleria-${mes}`;
            tableContainer.className = 'pasteleria-table-container';
            tableContainer.innerHTML = `
                <h3>Ventas de ${mes}</h3>
                <div class="form-section">
                    <input type="date" id="pasteleria-fecha-${mes}" placeholder="Fecha">
                    <input type="number" id="pasteleria-diatortas-${mes}" step="0.1" placeholder="D√≠a Tortas (kg)">
                    <input type="number" id="pasteleria-mesadulce-${mes}" step="0.1" placeholder="Mesa Dulce (u)">
                    <input type="number" id="pasteleria-celiaco-${mes}" step="0.1" placeholder="Celiaco (u)">
                    <button id="btn-agregar-pasteleria-${mes}">Agregar</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th class="pasteleria-cell">DIATORTAS X KG</th>
                            <th class="pasteleria-cell">MESA DULCE</th>
                            <th class="pasteleria-cell">CELIACO mesa dulce</th>
                            <th style="width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="pasteleria-list-${mes}"></tbody>
                    <tfoot>
                        <tr>
                            <td>TOTAL</td>
                            <td id="pasteleria-total-diatortas-${mes}"></td>
                            <td id="pasteleria-total-mesadulce-${mes}"></td>
                            <td id="pasteleria-total-celiaco-${mes}"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>PRECIO UNITARIO</td>
                            <td><div class="currency-input-container"><input type="number" id="precio-diatortas-${mes}" step="0.01" data-mes="${mes}"></div></td>
                            <td><div class="currency-input-container"><input type="number" id="precio-mesadulce-${mes}" step="0.01" data-mes="${mes}"></div></td>
                            <td><div class="currency-input-container"><input type="number" id="precio-celiaco-${mes}" step="0.01" data-mes="${mes}"></div></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>TOTAL PARCIAL</td>
                            <td id="pasteleria-parcial-diatortas-${mes}"></td>
                            <td id="pasteleria-parcial-mesadulce-${mes}"></td>
                            <td id="pasteleria-parcial-celiaco-${mes}"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="3" class="saldo-total">TOTAL FACTURACI√ìN</td>
                            <td colspan="2" id="pasteleria-total-final-${mes}"></td>
                        </tr>
                    </tfoot>
                </table>
            `;
            container.appendChild(tableContainer);
            
            document.getElementById(`btn-agregar-pasteleria-${mes}`).addEventListener('click', () => agregarVentaPasteleria(mes));
            
            document.getElementById(`precio-diatortas-${mes}`).addEventListener('change', () => actualizarPreciosPasteleria(mes));
            document.getElementById(`precio-mesadulce-${mes}`).addEventListener('change', () => actualizarPreciosPasteleria(mes));
            document.getElementById(`precio-celiaco-${mes}`).addEventListener('change', () => actualizarPreciosPasteleria(mes));
        });
        
        mostrarTablaPasteleria(mesActualPasteleria);
    }
    
    function mostrarTablaPasteleria(mes) {
        document.querySelectorAll('.pasteleria-table-container').forEach(el => el.style.display = 'none');
        document.getElementById(`tabla-pasteleria-${mes}`).style.display = 'block';
        document.querySelectorAll('.pasteleria-nav button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.pasteleria-nav button:nth-child(${meses.indexOf(mes) + 1})`).classList.add('active');
        mesActualPasteleria = mes;
        renderizarPasteleria(mes);
    }

    function renderizarPasteleria(mes) {
        const pasteleriaList = document.getElementById(`pasteleria-list-${mes}`);
        pasteleriaList.innerHTML = '';
        
        let totalDiatortas = 0;
        let totalMesadulce = 0;
        let totalCeliaco = 0;

        // tomamos a√±o seleccionado para mostrar ventas del a√±o seleccionado en la tabla del mes
        const selectedYear = document.getElementById('selector-ano').value;
        const ventasDelMes = (ventasByYear[selectedYear] && ventasByYear[selectedYear][mes]) ? [...ventasByYear[selectedYear][mes]] : [];
        ventasDelMes.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

        ventasDelMes.forEach((venta) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="editable" data-field="fecha" data-id="${venta.id}" data-mes="${mes}">${venta.fecha}</td>
                <td class="pasteleria-cell editable" data-field="diatortas" data-id="${venta.id}" data-mes="${mes}">${venta.diatortas}</td>
                <td class="pasteleria-cell editable" data-field="mesadulce" data-id="${venta.id}" data-mes="${mes}">${venta.mesadulce}</td>
                <td class="pasteleria-cell editable" data-field="celiaco" data-id="${venta.id}" data-mes="${mes}">${venta.celiaco}</td>
                <td style="text-align: center;"><button class="delete-btn" data-id="${venta.id}" data-mes="${mes}">‚ùå</button></td>
            `;
            pasteleriaList.appendChild(row);
            
            totalDiatortas += venta.diatortas;
            totalMesadulce += venta.mesadulce;
            totalCeliaco += venta.celiaco;
        });

        document.getElementById(`pasteleria-total-diatortas-${mes}`).textContent = totalDiatortas.toFixed(1);
        document.getElementById(`pasteleria-total-mesadulce-${mes}`).textContent = totalMesadulce;
        document.getElementById(`pasteleria-total-celiaco-${mes}`).textContent = totalCeliaco;
        
        // precio: prioridad a precio por a√±o_mes, si no existe, fallback a precio "global" por mes (legacy)
        const selectedYear = document.getElementById('selector-ano').value;
        const precioYearMonthKey = `${selectedYear}_${mes}`;
        const precios = preciosByYearMonth[precioYearMonthKey] || preciosByMonth[mes] || { DIATORTAS: 0, MESADULCE: 0, CELIACO: 0 };
        
        document.getElementById(`precio-diatortas-${mes}`).value = precios.DIATORTAS ?? 0;
        document.getElementById(`precio-mesadulce-${mes}`).value = precios.MESADULCE ?? 0;
        document.getElementById(`precio-celiaco-${mes}`).value = precios.CELIACO ?? 0;

        const parcialDiatortas = totalDiatortas * (precios.DIATORTAS || 0);
        const parcialMesadulce = totalMesadulce * (precios.MESADULCE || 0);
        const parcialCeliaco = totalCeliaco * (precios.CELIACO || 0);

        document.getElementById(`pasteleria-parcial-diatortas-${mes}`).textContent = formatCurrency(parcialDiatortas);
        document.getElementById(`pasteleria-parcial-mesadulce-${mes}`).textContent = formatCurrency(parcialMesadulce);
        document.getElementById(`pasteleria-parcial-celiaco-${mes}`).textContent = formatCurrency(parcialCeliaco);
        
        const totalFinal = parcialDiatortas + parcialMesadulce + parcialCeliaco;
        document.getElementById(`pasteleria-total-final-${mes}`).textContent = formatCurrency(totalFinal);
        
        addEditableListeners();

        pasteleriaList.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const id = this.dataset.id;
                if (confirm('¬øEst√°s seguro de que deseas eliminar esta venta?')) {
                    const docRef = doc(db, 'ventasPasteleria', id);
                    await deleteDoc(docRef);
                }
            });
        });
    }

    async function agregarVentaPasteleria(mes) {
        const fecha = document.getElementById(`pasteleria-fecha-${mes}`).value;
        const diatortas = parseFloat(document.getElementById(`pasteleria-diatortas-${mes}`).value) || 0;
        const mesadulce = parseFloat(document.getElementById(`pasteleria-mesadulce-${mes}`).value) || 0;
        const celiaco = parseFloat(document.getElementById(`pasteleria-celiaco-${mes}`).value) || 0;

        if (fecha) {
            try {
                // Al agregar, mantenemos la estructura original (doc con fields mes y fecha)
                await addDoc(ventasCol, { mes, fecha, diatortas, mesadulce, celiaco });
                document.getElementById(`pasteleria-fecha-${mes}`).value = '';
                document.getElementById(`pasteleria-diatortas-${mes}`).value = '';
                document.getElementById(`pasteleria-mesadulce-${mes}`).value = '';
                document.getElementById(`pasteleria-celiaco-${mes}`).value = '';
            } catch (e) {
                console.error("Error al agregar venta: ", e);
            }
        } else {
            alert('Por favor, ingrese la fecha de la venta.');
        }
    }
    
    async function actualizarPreciosPasteleria(mes) {
        const selectedYear = document.getElementById('selector-ano').value;
        const keyYearMonth = `${selectedYear}_${mes}`;

        const diatortas = parseFloat(document.getElementById(`precio-diatortas-${mes}`).value) || 0;
        const mesadulce = parseFloat(document.getElementById(`precio-mesadulce-${mes}`).value) || 0;
        const celiaco = parseFloat(document.getElementById(`precio-celiaco-${mes}`).value) || 0;
        
        // Guardamos en doc con id a√±o_mes para separar por a√±o
        const docRef = doc(db, 'preciosPasteleria', keyYearMonth);
        await setDoc(docRef, { DIATORTAS: diatortas, MESADULCE: mesadulce, CELIACO: celiaco }, { merge: true });
    }

    function addEditableListeners() {
        document.querySelectorAll('.pasteleria-table-container .editable').forEach(cell => {
            cell.ondblclick = function() {
                const mes = this.dataset.mes;
                const id = this.dataset.id;
                const field = this.dataset.field;
                const valor = this.textContent;

                const input = document.createElement('input');
                input.type = (field === 'fecha' ? 'date' : 'number');
                input.className = 'edit-input';
                input.value = valor;
                
                this.innerHTML = '';
                this.appendChild(input);
                
                input.focus();
                
                input.onblur = async function() {
                    const nuevoValor = this.value;
                    const docRef = doc(db, 'ventasPasteleria', id);
                    if (field === 'fecha') {
                        await updateDoc(docRef, { [field]: nuevoValor });
                    } else {
                        await updateDoc(docRef, { [field]: parseFloat(nuevoValor) || 0 });
                    }
                };
            };
        });
    }

    // --- L√≥gica del Resumen Anual (multi-a√±o) ---
    // Intentamos actualizar resumen solo cuando ventas, precios y resumen est√©n cargados
    function attemptActualizarResumen() {
        if (ventasLoaded && preciosLoaded && resumenLoaded) {
            actualizarResumenPasteleria();
        }
    }

    // Funci√≥n principal corregida y multi-a√±o
    async function actualizarResumenPasteleria() {
        const resumenBody = document.getElementById('resumen-pasteleria-body');
        resumenBody.innerHTML = '';

        const selectedYear = document.getElementById('selector-ano').value;

        // Obtenemos resumenByYear[selectedYear] si existe
        const resumenDataForYear = resumenByYear[selectedYear] || {};

        let totalAnterior = 0;

        // Recorremos mes por mes en orden para usar totalAnterior correctamente
        for (const mes of meses) {
            // ventas del mes filtradas por a√±o (seg√∫n la fecha de cada venta)
            const ventasDelMes = (ventasByYear[selectedYear] && ventasByYear[selectedYear][mes]) ? ventasByYear[selectedYear][mes] : [];
            const preciosKey = `${selectedYear}_${mes}`;
            const precios = preciosByYearMonth[preciosKey] || preciosByMonth[mes] || { DIATORTAS: 0, MESADULCE: 0, CELIACO: 0 };

            const totalDiatortas = ventasDelMes.reduce((sum, venta) => sum + (venta.diatortas || 0), 0);
            const totalMesadulce = ventasDelMes.reduce((sum, venta) => sum + (venta.mesadulce || 0), 0);
            const totalCeliaco = ventasDelMes.reduce((sum, venta) => sum + (venta.celiaco || 0), 0);

            const deudaDelMesCalculada = (totalDiatortas * precios.DIATORTAS) + (totalMesadulce * precios.MESADULCE) + (totalCeliaco * precios.CELIACO);

            const resumenDoc = resumenDataForYear[mes] || {};
            // Si Firestore tiene deudaDelMes almacenada expl√≠citamente, usamos eso; si no, usamos lo calculado
            const deudaDelMes = (typeof resumenDoc.deudaDelMes === 'number') ? resumenDoc.deudaDelMes : deudaDelMesCalculada;
            const pago = resumenDoc.pago ?? 0;
            const interes = resumenDoc.interes ?? 0;

            const deudaAcumulada = totalAnterior;

            // c√°lculo correcto:
            const totalCalculado = (deudaDelMes + deudaAcumulada - pago) * (1 + (interes / 100));
            const total = totalCalculado;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${mes}</td>
                <td class="editable-resumen" data-mes="${mes}" data-field="deudaDelMes">${formatCurrency(deudaDelMes)}</td>
                <td class="editable-resumen" data-mes="${mes}" data-field="deudaAcumulada">${formatCurrency(deudaAcumulada)}</td>
                <td class="editable-resumen" data-mes="${mes}" data-field="pago">${formatCurrency(pago)}</td>
                <td class="editable-resumen" data-mes="${mes}" data-field="interes">${interes.toFixed(2)}%</td>
                <td class="editable-resumen" data-mes="${mes}" data-field="total">${formatCurrency(total)}</td>
            `;
            resumenBody.appendChild(row);

            // Guardar en Firestore en doc id `${a√±o}_${mes}` para persistencia
            try {
                const docId = `${selectedYear}_${mes}`;
                const docRef = doc(db, 'resumenPasteleria', docId);
                await setDoc(docRef, { a√±o: parseInt(selectedYear,10), mes, deudaDelMes, deudaAcumulada, pago, interes, total }, { merge: true });
            } catch (e) {
                console.error('Error guardando resumenPasteleria para', mes, e);
            }

            // el total calculado pasa a ser deuda acumulada para el siguiente mes
            totalAnterior = total;
        }

        // Habilitar edici√≥n manual (igual que antes)
        document.querySelectorAll('.editable-resumen').forEach(cell => {
            cell.ondblclick = function() {
                const mes = this.dataset.mes;
                const field = this.dataset.field;
                const valorTexto = this.textContent.replace('$', '').replace(/\./g, '').replace(',', '.').replace('%', '');
                const valor = parseFloat(valorTexto) || 0;
                
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'edit-input';
                input.value = valor;
                input.step = "0.01";
                
                this.innerHTML = '';
                this.appendChild(input);
                input.focus();
                
                input.onblur = async function() {
                    const nuevoValor = parseFloat(this.value) || 0;
                    const selectedYear = document.getElementById('selector-ano').value;
                    const docId = `${selectedYear}_${mes}`;
                    const docRef = doc(db, 'resumenPasteleria', docId);
                    // guardamos el campo editado
                    await setDoc(docRef, { [field]: nuevoValor }, { merge: true });
                    // Refrescar el resumen (lo recalcula todo)
                    await actualizarResumenPasteleria();
                };
            };
        });
    }

    // --- Listeners para Pasteler√≠a y Resumen ---
    onSnapshot(preciosCol, (snapshot) => {
        // reinicializamos
        preciosByMonth = {};
        preciosByYearMonth = {};
        snapshot.docs.forEach(docSnap => {
            const id = docSnap.id; // puede ser "Enero" (legacy) o "2025_Enero" (nuevo)
            const data = docSnap.data();
            if (id.includes('_')) {
                // formato a√±o_mes
                preciosByYearMonth[id] = data;
            } else {
                // legacy por mes
                preciosByMonth[id] = data;
            }
        });
        preciosLoaded = true;
        // re-render de la tabla visible por si cambi√≥ el precio del mes seleccionado
        renderizarPasteleria(mesActualPasteleria);
        attemptActualizarResumen();
    });

    onSnapshot(ventasCol, (snapshot) => {
        // reconstruimos ventasByYear
        ventasByYear = {};
        snapshot.docs.forEach(docSnap => {
            const data = { id: docSnap.id, ...docSnap.data() };
            // data.mes deber√≠a existir (p. ej. 'Febrero') y data.fecha en formato 'YYYY-MM-DD'
            const fechaStr = data.fecha || '';
            let year = null;
            if (fechaStr && fechaStr.includes('-')) {
                year = fechaStr.split('-')[0];
            } else {
                // si no hay fecha, asumimos 2025 para compatibilidad (pero ideal que tenga fecha)
                year = '2025';
            }
            if (!ventasByYear[year]) ventasByYear[year] = {};
            if (!ventasByYear[year][data.mes]) ventasByYear[year][data.mes] = [];
            ventasByYear[year][data.mes].push(data);
        });
        ventasLoaded = true;
        renderizarPasteleria(mesActualPasteleria);
        attemptActualizarResumen();
    });
    
    onSnapshot(resumenPasteleriaCol, (snapshot) => {
        // reconstruimos resumenByYear
        resumenByYear = {};
        snapshot.docs.forEach(docSnap => {
            const id = docSnap.id; // puede ser '2025_Enero' o 'Enero' (legacy)
            const data = docSnap.data();
            if (id.includes('_')) {
                const [yr, mes] = id.split('_');
                if (!resumenByYear[yr]) resumenByYear[yr] = {};
                resumenByYear[yr][mes] = data;
            } else {
                // legacy: documento llamado 'Enero' -> lo guardamos en 2025 por compatibilidad
                const yr = (data.a√±o && String(data.a√±o)) || '2025';
                if (!resumenByYear[yr]) resumenByYear[yr] = {};
                resumenByYear[yr][id] = data;
            }
        });
        resumenLoaded = true;
        attemptActualizarResumen();
    });

    // --- Carga Inicial de Datos (se ejecuta solo si la colecci√≥n est√° vac√≠a) ---
    async function cargarDatosIniciales() {
        const datosInicialesGastos = [
            { fecha: '2025-01-08', descripcion: 'CONSTRUSEC', monto: 51017.94 },
            { fecha: '2025-01-08', descripcion: 'PROMAT', monto: 53700.00 },
            { fecha: '2025-01-09', descripcion: 'PROMAT', monto: 30664.57 },
            { fecha: '2025-01-13', descripcion: 'CONSTRUSEC', monto: 11541.96 },
            { fecha: '2025-01-13', descripcion: 'IMCOFUE', monto: 39318.00 },
            { fecha: '2025-01-15', descripcion: 'IMCOFUE', monto: 21467.00 },
            { fecha: '2025-01-30', descripcion: 'DON LUCIO', monto: 49450.00 },
            { fecha: '2025-02-18', descripcion: 'DIARCO', monto: 60166.54 },
            { fecha: '2025-02-19', descripcion: 'DON LUCIO', monto: 74815.00 },
            { fecha: '2025-02-20', descripcion: 'MIGA', monto: 26000.00 },
            { fecha: '2025-02-27', descripcion: 'LA ANONIMA', monto: 37787.33 },
            { fecha: '2025-02-24', descripcion: 'LA ANONIMA', monto: 20064.44 }
        ];

        const datosInicialesSueldos = [
            { mes: 'Enero', descripcion: 'Sueldo base', montoK: 250000, montoMilei: 150000, kPagado: false, mileiPagado: false },
            { mes: 'Febrero', descripcion: 'Sueldo base', montoK: 260000, montoMilei: 160000, kPagado: false, mileiPagado: false },
            { mes: 'Febrero', descripcion: 'Bono extra', montoK: 0, montoMilei: 50000, kPagado: false, mileiPagado: false },
            { mes: 'Marzo', descripcion: 'Sueldo base', montoK: 270000, montoMilei: 170000, kPagado: false, mileiPagado: false },
            { mes: 'Abril', descripcion: 'Sueldo base', montoK: 280000, montoMilei: 180000, kPagado: false, mileiPagado: false },
            { mes: 'Mayo', descripcion: 'Sueldo base', montoK: 290000, montoMilei: 190000, kPagado: false, mileiPagado: false },
            { mes: 'Junio', descripcion: 'Sueldo base', montoK: 300000, montoMilei: 200000, kPagado: false, mileiPagado: false }
        ];

        const datosInicialesInflacion = [
            { mes: 'Enero', inflacion: 1.0 },
            { mes: 'Febrero', inflacion: 1.5 },
            { mes: 'Marzo', inflacion: 2.0 },
            { mes: 'Abril', inflacion: 1.8 },
            { mes: 'Mayo', inflacion: 2.5 },
            { mes: 'Junio', inflacion: 3.0 }
        ];

        const datosInicialesVentas = {
            'Febrero': [
                { fecha: '2025-02-01', diatortas: 4.5, mesadulce: 4, celiaco: 5 },
                { fecha: '2025-02-21', diatortas: 4, mesadulce: 4, celiaco: 5 },
                { fecha: '2025-02-22', diatortas: 6.6, mesadulce: 5, celiaco: 12 },
                { fecha: '2025-02-28', diatortas: 3.3, mesadulce: 5, celiaco: 1 },
            ],
            'Marzo': [
                { fecha: '2025-03-01', diatortas: 5, mesadulce: 4, celiaco: 5 },
                { fecha: '2025-03-07', diatortas: 4, mesadulce: 1, celiaco: 5 },
                { fecha: '2025-03-15', diatortas: 6.5, mesadulce: 0, celiaco: 18 },
                { fecha: '2025-03-18', diatortas: 2.1, mesadulce: 8, celiaco: 3 },
                { fecha: '2025-03-23', diatortas: 5, mesadulce: 4, celiaco: 5 },
                { fecha: '2025-03-28', diatortas: 5, mesadulce: 2, celiaco: 9 },
            ],
            'Abril': [
                { fecha: '2025-04-05', diatortas: 6.5, mesadulce: 5, celiaco: 1 },
                { fecha: '2025-04-12', diatortas: 8.0, mesadulce: 0, celiaco: 2 },
                { fecha: '2025-04-24', diatortas: 2.0, mesadulce: 2, celiaco: 0 },
                { fecha: '2025-04-25', diatortas: 4.5, mesadulce: 5, celiaco: 0 },
                { fecha: '2025-04-26', diatortas: 8.0, mesadulce: 1, celiaco: 0 },
            ],
            'Mayo': [
                { fecha: '2025-05-03', diatortas: 5, mesadulce: 5, celiaco: 0 },
                { fecha: '2025-05-10', diatortas: 5, mesadulce: 5, celiaco: 5 },
                { fecha: '2025-05-17', diatortas: 4, mesadulce: 2, celiaco: 0 },
                { fecha: '2025-05-24', diatortas: 5.5, mesadulce: 6, celiaco: 0 },
                { fecha: '2025-05-31', diatortas: 4, mesadulce: 4, celiaco: 5 },
            ],
            'Junio': [
                { fecha: '2025-06-01', diatortas: 4, mesadulce: 3, celiaco: 0 },
                { fecha: '2025-06-07', diatortas: 6, mesadulce: 4, celiaco: 0 },
            ]
        };

        const datosInicialesPrecios = {
            'Enero': { 'DIATORTAS': 23611, 'MESADULCE': 3091, 'CELIACO': 3465 },
            'Febrero': { 'DIATORTAS': 23611, 'MESADULCE': 3091, 'CELIACO': 3465 },
            'Marzo': { 'DIATORTAS': 24083, 'MESADULCE': 3153, 'CELIACO': 3570 },
            'Abril': { 'DIATORTAS': 25046, 'MESADULCE': 3279, 'CELIACO': 3713 },
            'Mayo': { 'DIATORTAS': 25546, 'MESADULCE': 3345, 'CELIACO': 3787 },
            'Junio': { 'DIATORTAS': 26056, 'MESADULCE': 3412, 'CELIACO': 3787 },
            'Julio': { 'DIATORTAS': 0, 'MESADULCE': 0, 'CELIACO': 0 },
            'Agosto': { 'DIATORTAS': 0, 'MESADULCE': 0, 'CELIACO': 0 },
            'Septiembre': { 'DIATORTAS': 0, 'MESADULCE': 0, 'CELIACO': 0 },
            'Octubre': { 'DIATORTAS': 0, 'MESADULCE': 0, 'CELIACO': 0 },
            'Noviembre': { 'DIATORTAS': 0, 'MESADULCE': 0, 'CELIACO': 0 },
            'Diciembre': { 'DIATORTAS': 0, 'MESADULCE': 0, 'CELIACO': 0 }
        };

        const datosInicialesResumen = {
            'Enero': { deudaAcumulada: 6659825.09, pago: 6000000, interes: 0.5 },
            'Febrero': { deudaAcumulada: 0, pago: 0, interes: 5 },
            'Marzo': { deudaAcumulada: 0, pago: 0, interes: 5 },
            'Abril': { deudaAcumulada: 0, pago: 0, interes: 4 },
            'Mayo': { deudaAcumulada: 0, pago: 0, interes: 4 },
            'Junio': { deudaAcumulada: 0, pago: 0, interes: 5 }
        };

        const gastosDocs = await getDocs(gastosCol);
        if (gastosDocs.empty) {
            for (const gasto of datosInicialesGastos) {
                await addDoc(gastosCol, gasto);
            }
        }
        const sueldosDocs = await getDocs(sueldosCol);
        if (sueldosDocs.empty) {
            for (const sueldo of datosInicialesSueldos) {
                await addDoc(sueldosCol, sueldo);
            }
        }
        const inflacionDocs = await getDocs(inflacionCol);
        if (inflacionDocs.empty) {
            for (const inflacion of datosInicialesInflacion) {
                await setDoc(doc(db, 'inflacion', inflacion.mes), { inflacion: inflacion.inflacion });
            }
        }
        const preciosDocs = await getDocs(preciosCol);
        if (preciosDocs.empty) {
            for (const mes in datosInicialesPrecios) {
                // guardamos legacy (solo mes) precios
                await setDoc(doc(db, 'preciosPasteleria', mes), datosInicialesPrecios[mes]);
                // y adem√°s guardamos un precio por defecto para 2025_mes para que el selector de 2025 tenga datos
                await setDoc(doc(db, 'preciosPasteleria', `2025_${mes}`), datosInicialesPrecios[mes]);
            }
        }
        const ventasDocs = await getDocs(ventasCol);
        if (ventasDocs.empty) {
            for (const mes in datosInicialesVentas) {
                for (const venta of datosInicialesVentas[mes]) {
                    await addDoc(ventasCol, { ...venta, mes });
                }
            }
        }
        const resumenDocs = await getDocs(resumenPasteleriaCol);
        if (resumenDocs.empty) {
            // guardamos en formato 2025_Mes para el a√±o 2025
            for (const mes in datosInicialesResumen) {
                await setDoc(doc(db, 'resumenPasteleria', `2025_${mes}`), datosInicialesResumen[mes]);
            }
        }
    }

    // --- Inicializaci√≥n al cargar la p√°gina ---
    document.addEventListener('DOMContentLoaded', function() {
        calcularMontoPrestamo();
        cargarDatosIniciales();
        crearTablasPasteleria();
        
        document.getElementById('btn-agregar-gasto').addEventListener('click', agregarGasto);
        document.getElementById('btn-agregar-sueldo').addEventListener('click', agregarSueldo);

        // cambiar a√±o reenfuerza el render y recalculo
        document.getElementById('selector-ano').addEventListener('change', () => {
            renderizarPasteleria(mesActualPasteleria);
            attemptActualizarResumen();
        });
    });
</script>

</body>
</html>
