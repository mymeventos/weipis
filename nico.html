<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte General de Gastos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            color: #007bff;
            margin-bottom: 40px;
        }
        h2 {
            color: #333;
            margin-top: 0;
        }
        .section {
            border-bottom: 2px solid #ddd;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }
        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            white-space: nowrap;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        td.pagado {
            background-color: #d4edda;
        }
        td.adeudado {
            background-color: #f8d7da;
        }
        .saldo-total {
            text-align: right;
            font-size: 1.2em;
            margin-top: 10px;
            font-weight: bold;
        }
        .pasteleria-cell {
            text-align: center;
        }
        .pasteleria-table-container {
            display: none;
            margin-bottom: 20px;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        .pasteleria-nav {
            text-align: center;
            margin-bottom: 20px;
        }
        .pasteleria-nav button {
            padding: 8px 15px;
            margin: 0 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .pasteleria-nav button.active {
            background-color: #0056b3;
        }
        .summary-table td {
            text-align: right;
        }
        .summary-table td:first-child {
            text-align: left;
        }
        .desglose-prestamo {
            margin-top: 20px;
            display: none;
        }
        .desglose-prestamo table {
            width: 100%;
        }
        .btn-moderno {
            margin-top: 15px;
            width: 100%;
            padding: 10px;
            font-size: 1.1em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-moderno:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Reporte General de Gastos y Sueldos</h1>
    
    <div class="section">
        <h2>Caja Chica</h2>
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Descripción</th>
                    <th>Monto</th>
                </tr>
            </thead>
            <tbody id="caja-chica-list"></tbody>
        </table>
        <div class="saldo-total">Saldo Disponible: <span id="saldo-disponible"></span></div>
    </div>

    <div class="section">
        <h2>Sueldos</h2>
        <table id="sueldos-table">
            <thead>
                <tr>
                    <th>Mes</th>
                    <th>Descripción</th>
                    <th>Monto 'K'</th>
                    <th>Monto 'Milei'</th>
                    <th>Inflación (%)</th>
                </tr>
            </thead>
            <tbody id="sueldos-list"></tbody>
            <tfoot>
                <tr id="sueldos-total-row">
                    <td colspan="4" class="saldo-total">Total Adeudado General</td>
                    <td id="sueldos-total" class="saldo-total"></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="section">
        <h2>Pastelería</h2>
        <div class="pasteleria-nav" id="pasteleria-nav"></div>
        <div id="pasteleria-meses-container"></div>
    </div>

    <div class="section">
        <h2>Resumen Pastelería</h2>
        <table class="summary-table">
            <thead>
                <tr>
                    <th>MES</th>
                    <th>DEUDA DEL MES</th>
                    <th>DEUDA ACUMULADA</th>
                    <th>PAGO</th>
                    <th>% INTERÉS</th>
                    <th>TOTAL</th>
                </tr>
            </thead>
            <tbody id="resumen-pasteleria-body"></tbody>
        </table>
    </div>

    <div class="section">
        <h2>Préstamo</h2>
        <div id="prestamo-content">
            <p>Monto Inicial: $6.000.000,00</p>
            <p>Interés Semanal: 1.5%</p>
            <p>Fecha de Inicio: 7/01/2025</p>
            <div class="saldo-total">Monto Adeudado a la fecha: <span id="montoFinalPrestamo"></span></div>
            <button id="btn-desglose-prestamo" class="btn-moderno">Mostrar Desglose Semanal</button>
            <div class="desglose-prestamo" id="desglose-prestamo-container">
                <table id="desglose-prestamo-table">
                    <thead>
                        <tr>
                            <th>Semana</th>
                            <th>Período</th>
                            <th>Monto Adeudado</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBt_R-0uXeZ0-ZbTGX6CbgI6ZWqtov56PA",
      authDomain: "weipis.firebaseapp.com",
      projectId: "weipis",
      storageBucket: "weipis.firebasestorage.app",
      messagingSenderId: "95209854420",
      appId: "1:95209854420:web:c4b5c1636300a04a33f241",
      measurementId: "G-1131L1FKJ4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('es-AR', {
            style: 'currency',
            currency: 'ARS',
            minimumFractionDigits: 2
        }).format(amount);
    };

    const formatDate = (dateString) => {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    };
    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

    // --- Lógica de Préstamo ---
    function calcularMontoPrestamo() {
        const montoInicial = 6000000;
        const interesSemanal = 0.015;
        const fechaInicio = new Date('2025-01-07');
        const fechaActual = new Date();
        const unaSemanaEnMs = 1000 * 60 * 60 * 24 * 7;
        const diferenciaMs = fechaActual.getTime() - fechaInicio.getTime();
        const semanasTranscurridas = Math.max(0, Math.floor(diferenciaMs / unaSemanaEnMs));
        
        let montoCalculado = montoInicial;
        for (let i = 0; i < semanasTranscurridas; i++) {
            montoCalculado *= (1 + interesSemanal);
        }
        document.getElementById('montoFinalPrestamo').textContent = formatCurrency(montoCalculado);
    }
    
    function mostrarDesglosePrestamo() {
        const desgloseContainer = document.getElementById('desglose-prestamo-container');
        const desgloseTableBody = document.querySelector('#desglose-prestamo-table tbody');
        desgloseTableBody.innerHTML = '';
        
        const montoInicial = 6000000;
        const interesSemanal = 0.015;
        let fechaActual = new Date('2025-01-07');
        let montoSemanal = montoInicial;
        let semana = 1;
        
        while (fechaActual <= new Date()) {
            const fechaFinSemana = new Date(fechaActual.getTime() + 6 * 24 * 60 * 60 * 1000);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>Semana ${semana}</td>
                <td>${fechaActual.toLocaleDateString('es-AR')} - ${fechaFinSemana.toLocaleDateString('es-AR')}</td>
                <td>${formatCurrency(montoSemanal)}</td>
            `;
            desgloseTableBody.appendChild(row);
            
            montoSemanal *= (1 + interesSemanal);
            fechaActual = new Date(fechaFinSemana.getTime() + 1 * 24 * 60 * 60 * 1000);
            semana++;
        }
        
        desgloseContainer.style.display = 'block';
    }

    // --- Lógica de Caja Chica ---
    const saldoInicialCajaChica = 300000;
    const gastosCol = collection(db, 'gastos');
    let gastos = [];
    
    function renderizarCajaChica() {
        const gastosList = document.getElementById('caja-chica-list');
        gastosList.innerHTML = '';
        
        const depositoRow = document.createElement('tr');
        depositoRow.innerHTML = `<td>${formatDate('2025-01-01')}</td><td>DEPOSITO</td><td>${formatCurrency(saldoInicialCajaChica)}</td>`;
        gastosList.appendChild(depositoRow);

        let totalGastos = 0;
        
        const gastosOrdenados = [...gastos].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

        gastosOrdenados.forEach(gasto => {
            totalGastos += gasto.monto;
            const row = document.createElement('tr');
            row.innerHTML = `<td>${formatDate(gasto.fecha)}</td><td>${gasto.descripcion}</td><td>- ${formatCurrency(gasto.monto)}</td>`;
            gastosList.appendChild(row);
        });

        const saldoFinal = saldoInicialCajaChica - totalGastos;
        document.getElementById('saldo-disponible').textContent = formatCurrency(saldoFinal);
    }
    
    // --- Lógica de Sueldos ---
    const sueldosCol = collection(db, 'sueldos');
    const inflacionCol = collection(db, 'inflacion');
    let sueldos = [];
    let inflacionData = {};
    
    function renderizarSueldos() {
        const sueldosList = document.getElementById('sueldos-list');
        if (!sueldosList) return;
        sueldosList.innerHTML = '';
        
        let montoAcumuladoConInteres = 0;
        
        const sueldosPorMes = meses.reduce((acc, mes) => {
            acc[mes] = sueldos.filter(s => s.mes === mes);
            return acc;
        }, {});

        meses.forEach((mes) => {
            const pagosDelMes = sueldosPorMes[mes] || [];
            const inflacion = inflacionData[mes] || 0;
            
            montoAcumuladoConInteres *= (1 + inflacion / 100);

            let montoBasePendiente = 0;
            if (pagosDelMes.length > 0) {
                 const totalPagadoK = pagosDelMes.filter(p => p.kPagado).reduce((sum, p) => sum + p.montoK, 0);
                 const totalPagadoMilei = pagosDelMes.filter(p => p.mileiPagado).reduce((sum, p) => sum + p.montoMilei, 0);
                 const totalMontoKMes = pagosDelMes.reduce((sum, p) => sum + p.montoK, 0);
                 const totalMontoMileiMes = pagosDelMes.reduce((sum, p) => sum + p.montoMilei, 0);
                 montoBasePendiente = (totalMontoKMes - totalPagadoK) + (totalMontoMileiMes - totalPagadoMilei);
            }
            montoAcumuladoConInteres += montoBasePendiente;

            if (pagosDelMes.length > 0) {
                pagosDelMes.forEach((pago, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index === 0 ? mes : ''}</td>
                        <td>${pago.descripcion}</td>
                        <td class="${pago.kPagado ? 'pagado' : 'adeudado'}">${formatCurrency(pago.montoK)}</td>
                        <td class="${pago.mileiPagado ? 'pagado' : 'adeudado'}">${formatCurrency(pago.montoMilei)}</td>
                        <td>${index === 0 ? `${inflacion.toFixed(1)}%` : ''}</td>
                    `;
                    sueldosList.appendChild(row);
                });
            }
        });
        
        document.getElementById('sueldos-total').textContent = formatCurrency(montoAcumuladoConInteres);
    }
    
    // --- Lógica de Pastelería ---
    const ventasCol = collection(db, 'ventasPasteleria');
    const preciosCol = collection(db, 'preciosPasteleria');
    const resumenPasteleriaCol = collection(db, 'resumenPasteleria');
    let ventasPasteleria = {};
    let preciosPasteleriaPorMes = {};
    let resumenPasteleria = {};
    let mesActualPasteleria = 'Febrero';

    function crearTablasPasteleria() {
        const nav = document.getElementById('pasteleria-nav');
        nav.innerHTML = '';
        meses.forEach(mes => {
            const button = document.createElement('button');
            button.textContent = mes;
            button.addEventListener('click', () => mostrarTablaPasteleria(mes));
            nav.appendChild(button);
        });
        const container = document.getElementById('pasteleria-meses-container');
        container.innerHTML = '';
        meses.forEach(mes => {
            const tableContainer = document.createElement('div');
            tableContainer.id = `tabla-pasteleria-${mes}`;
            tableContainer.className = 'pasteleria-table-container';
            tableContainer.innerHTML = `
                <h3>Ventas de ${mes}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th class="pasteleria-cell">DIATORTAS X KG</th>
                            <th class="pasteleria-cell">MESA DULCE</th>
                            <th class="pasteleria-cell">CELIACO mesa dulce</th>
                        </tr>
                    </thead>
                    <tbody id="pasteleria-list-${mes}"></tbody>
                    <tfoot>
                        <tr>
                            <td>TOTAL</td>
                            <td id="pasteleria-total-diatortas-${mes}"></td>
                            <td id="pasteleria-total-mesadulce-${mes}"></td>
                            <td id="pasteleria-total-celiaco-${mes}"></td>
                        </tr>
                        <tr>
                            <td>PRECIO UNITARIO</td>
                            <td id="precio-diatortas-${mes}"></td>
                            <td id="precio-mesadulce-${mes}"></td>
                            <td id="precio-celiaco-${mes}"></td>
                        </tr>
                        <tr>
                            <td>TOTAL PARCIAL</td>
                            <td id="pasteleria-parcial-diatortas-${mes}"></td>
                            <td id="pasteleria-parcial-mesadulce-${mes}"></td>
                            <td id="pasteleria-parcial-celiaco-${mes}"></td>
                        </tr>
                        <tr>
                            <td colspan="3" class="saldo-total">TOTAL FACTURACIÓN</td>
                            <td id="pasteleria-total-final-${mes}"></td>
                        </tr>
                    </tfoot>
                </table>
            `;
            container.appendChild(tableContainer);
        });
        
        mostrarTablaPasteleria(mesActualPasteleria);
    }
    
    function mostrarTablaPasteleria(mes) {
        document.querySelectorAll('.pasteleria-table-container').forEach(el => el.style.display = 'none');
        const tableContainer = document.getElementById(`tabla-pasteleria-${mes}`);
        if (tableContainer) {
            tableContainer.style.display = 'block';
        }
        document.querySelectorAll('.pasteleria-nav button').forEach(btn => btn.classList.remove('active'));
        const navButton = document.querySelector(`.pasteleria-nav button:nth-child(${meses.indexOf(mes) + 1})`);
        if (navButton) {
            navButton.classList.add('active');
        }
        mesActualPasteleria = mes;
        renderizarPasteleria(mes);
    }

    function renderizarPasteleria(mes) {
        const pasteleriaList = document.getElementById(`pasteleria-list-${mes}`);
        if (!pasteleriaList) return;
        pasteleriaList.innerHTML = '';
        
        let totalDiatortas = 0;
        let totalMesadulce = 0;
        let totalCeliaco = 0;

        const ventasDelMes = ventasPasteleria[mes] || [];
        ventasDelMes.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

        ventasDelMes.forEach((venta) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(venta.fecha)}</td>
                <td class="pasteleria-cell">${venta.diatortas}</td>
                <td class="pasteleria-cell">${venta.mesadulce}</td>
                <td class="pasteleria-cell">${venta.celiaco}</td>
            `;
            pasteleriaList.appendChild(row);
            
            totalDiatortas += venta.diatortas;
            totalMesadulce += venta.mesadulce;
            totalCeliaco += venta.celiaco;
        });

        document.getElementById(`pasteleria-total-diatortas-${mes}`).textContent = totalDiatortas.toFixed(1);
        document.getElementById(`pasteleria-total-mesadulce-${mes}`).textContent = totalMesadulce;
        document.getElementById(`pasteleria-total-celiaco-${mes}`).textContent = totalCeliaco;
        
        const precios = preciosPasteleriaPorMes[mes] || { DIATORTAS: 0, MESADULCE: 0, CELIACO: 0 };
        
        document.getElementById(`precio-diatortas-${mes}`).textContent = formatCurrency(precios.DIATORTAS);
        document.getElementById(`precio-mesadulce-${mes}`).textContent = formatCurrency(precios.MESADULCE);
        document.getElementById(`precio-celiaco-${mes}`).textContent = formatCurrency(precios.CELIACO);

        const parcialDiatortas = totalDiatortas * precios.DIATORTAS;
        const parcialMesadulce = totalMesadulce * precios.MESADULCE;
        const parcialCeliaco = totalCeliaco * precios.CELIACO;

        document.getElementById(`pasteleria-parcial-diatortas-${mes}`).textContent = formatCurrency(parcialDiatortas);
        document.getElementById(`pasteleria-parcial-mesadulce-${mes}`).textContent = formatCurrency(parcialMesadulce);
        document.getElementById(`pasteleria-parcial-celiaco-${mes}`).textContent = formatCurrency(parcialCeliaco);
        
        const totalFinal = parcialDiatortas + parcialMesadulce + parcialCeliaco;
        document.getElementById(`pasteleria-total-final-${mes}`).textContent = formatCurrency(totalFinal);
    }
    
    // --- Lógica del Resumen Anual ---
    function actualizarResumenPasteleria() {
        const resumenBody = document.getElementById('resumen-pasteleria-body');
        resumenBody.innerHTML = '';
        
        let totalAnterior = 0;

        meses.forEach(mes => {
            const ventasDelMes = ventasPasteleria[mes] || [];
            const precios = preciosPasteleriaPorMes[mes] || { DIATORTAS: 0, MESADULCE: 0, CELIACO: 0 };
            
            const facturacionDelMes = 
                (ventasDelMes.reduce((sum, v) => sum + v.diatortas, 0) * precios.DIATORTAS) +
                (ventasDelMes.reduce((sum, v) => sum + v.mesadulce, 0) * precios.MESADULCE) +
                (ventasDelMes.reduce((sum, v) => sum + v.celiaco, 0) * precios.CELIACO);
            
            const resumenData = resumenPasteleria[mes] || {};
            const deudaDelMes = resumenData.deudaDelMes ?? facturacionDelMes;
            const pago = resumenData.pago ?? 0;
            const interes = resumenData.interes ?? 0;
            
            const deudaAcumulada = totalAnterior;
            
            const total = (deudaAcumulada + deudaDelMes - pago) * (1 + interes / 100);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${mes}</td>
                <td>${formatCurrency(deudaDelMes)}</td>
                <td>${formatCurrency(deudaAcumulada)}</td>
                <td>${formatCurrency(pago)}</td>
                <td>${interes.toFixed(2)}%</td>
                <td>${formatCurrency(total)}</td>
            `;
            resumenBody.appendChild(row);

            totalAnterior = total;
        });
    }

    // --- Inicialización al cargar la página ---
    document.addEventListener('DOMContentLoaded', function() {
        onSnapshot(gastosCol, (snapshot) => {
            gastos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderizarCajaChica();
        });

        onSnapshot(sueldosCol, (snapshot) => {
            sueldos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderizarSueldos();
            actualizarResumenPasteleria();
        });

        onSnapshot(inflacionCol, (snapshot) => {
            inflacionData = {};
            snapshot.docs.forEach(doc => {
                inflacionData[doc.id] = doc.data().inflacion;
            });
            renderizarSueldos();
            actualizarResumenPasteleria();
        });

        onSnapshot(preciosCol, (snapshot) => {
            preciosPasteleriaPorMes = {};
            snapshot.docs.forEach(doc => {
                preciosPasteleriaPorMes[doc.id] = doc.data();
            });
            renderizarPasteleria(mesActualPasteleria);
            actualizarResumenPasteleria();
        });

        onSnapshot(ventasCol, (snapshot) => {
            ventasPasteleria = {};
            snapshot.docs.forEach(doc => {
                const data = { id: doc.id, ...doc.data() };
                if (!ventasPasteleria[data.mes]) {
                    ventasPasteleria[data.mes] = [];
                }
                ventasPasteleria[data.mes].push(data);
            });
            renderizarPasteleria(mesActualPasteleria);
            actualizarResumenPasteleria();
        });
        
        onSnapshot(resumenPasteleriaCol, (snapshot) => {
            resumenPasteleria = {};
            snapshot.docs.forEach(doc => {
                resumenPasteleria[doc.id] = doc.data();
            });
            actualizarResumenPasteleria();
        });

        calcularMontoPrestamo();
        crearTablasPasteleria();
        
        document.getElementById('btn-desglose-prestamo').addEventListener('click', mostrarDesglosePrestamo);
    });
</script>

</body>
</html>
